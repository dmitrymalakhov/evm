# Исправление проблем с веб-порталом на продакшене

## Быстрая диагностика

Запустите скрипт диагностики:

```bash
./diagnose-web-production.sh
```

Этот скрипт проверит:
- Статус контейнеров Docker
- Логи web контейнера
- Доступность порта 3000
- Конфигурацию nginx
- Наличие собранных файлов
- Переменные окружения

## Автоматическое исправление

Если диагностика выявила проблемы, запустите скрипт исправления:

```bash
./fix-web-production.sh
```

Этот скрипт:
1. Остановит и удалит старый web контейнер
2. Проверит/создаст .env файл с правильным NEXT_PUBLIC_API_URL
3. Пересоберет Docker образ
4. Запустит контейнер
5. Проверит доступность

## Ручное исправление

Если автоматическое исправление не помогло:

### 1. Проверьте логи контейнера

```bash
ssh root@207.154.207.198 'docker logs evm-web --tail 100'
```

### 2. Проверьте статус контейнера

```bash
ssh root@207.154.207.198 'docker ps -a | grep evm-web'
```

### 3. Проверьте .env файл на сервере

```bash
ssh root@207.154.207.198 'cat /root/evm/.env | grep NEXT_PUBLIC_API_URL'
```

Должно быть:
```
NEXT_PUBLIC_API_URL=https://cyberelka2077.ru/api
```

### 4. Пересоберите и задеплойте

Если проблема в том, что проект не собран с правильным NEXT_PUBLIC_API_URL:

1. Убедитесь, что у вас есть .env файл в корне проекта с:
   ```
   NEXT_PUBLIC_API_URL=https://cyberelka2077.ru/api
   ```

2. Запустите деплой:
   ```bash
   ./deploy.sh --web
   ```

### 5. Проверьте nginx

```bash
ssh root@207.154.207.198 'nginx -t && systemctl reload nginx'
```

## Частые проблемы

### Проблема: Контейнер не запускается

**Решение:**
- Проверьте логи: `docker logs evm-web --tail 100`
- Убедитесь, что порт 3000 не занят другим процессом
- Проверьте, что .next/standalone директория существует на сервере

### Проблема: NEXT_PUBLIC_API_URL неправильный

**Решение:**
- Убедитесь, что .env файл существует и содержит правильное значение
- Пересоберите проект с правильной переменной окружения
- Учтите, что NEXT_PUBLIC_* переменные встраиваются во время сборки, а не во время выполнения

### Проблема: Nginx не проксирует запросы

**Решение:**
- Проверьте конфигурацию nginx: `/etc/nginx/sites-available/cyberelka2077.ru.conf`
- Убедитесь, что nginx запущен: `systemctl status nginx`
- Проверьте логи nginx: `tail -f /var/log/nginx/error.log`

### Проблема: Standalone директория не найдена

**Решение:**
- Убедитесь, что next.config.ts содержит `output: "standalone"`
- Пересоберите проект локально: `cd web && pnpm run build`
- Проверьте, что .next/standalone существует после сборки

## Проверка после исправления

1. Проверьте доступность сайта: https://cyberelka2077.ru
2. Проверьте консоль браузера на наличие ошибок
3. Проверьте, что API запросы идут на правильный URL



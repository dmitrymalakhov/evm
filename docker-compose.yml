version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile
      shm_size: '256m'
    container_name: evm-api
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    ports:
      - "${API_PORT:-4000}:4000"
    environment:
      - NODE_ENV=development
      - PORT=4000
      - HOST=0.0.0.0
      # База данных сохраняется в volume api_data
      - SQLITE_PATH=/app/data/evm.sqlite
      - DRIZZLE_MIGRATE=true
      - CORS_ORIGIN=${CORS_ORIGIN:-http://localhost:3000}
    volumes:
      # Volume для базы данных - данные сохраняются между пересборками контейнера
      - api_data:/app/data
      # Volume для загруженных файлов
      - api_uploads:/app/uploads
    networks:
      - evm-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:4000}
    container_name: evm-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      - NODE_ENV=development
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:4000}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - evm-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  telegram-bot:
    build:
      context: .
      dockerfile: telegram-bot/Dockerfile
    container_name: evm-telegram-bot
    restart: unless-stopped
    environment:
      - NODE_ENV=development
      - BOT_TOKEN=${BOT_TOKEN}
      - API_BASE_URL=${API_BASE_URL:-http://api:4000}
      - API_TIMEOUT=${API_TIMEOUT:-10000}
      - API_RETRY_ATTEMPTS=${API_RETRY_ATTEMPTS:-3}
      - API_RETRY_DELAY=${API_RETRY_DELAY:-1000}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - evm-network
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'node dist/index.js' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  evm-network:
    driver: bridge

volumes:
  # Постоянное хранилище для базы данных SQLite
  # Данные сохраняются между пересборками и перезапусками контейнеров
  api_data:
    driver: local
  # Постоянное хранилище для загруженных файлов
  api_uploads:
    driver: local


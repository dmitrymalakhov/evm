version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: api/Dockerfile.prod
    image: evm-api:latest
    container_name: evm-api
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    ports:
      - "${API_PORT:-4000}:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - HOST=0.0.0.0
      - SQLITE_PATH=/app/data/evm.sqlite
      - DRIZZLE_MIGRATE=${DRIZZLE_MIGRATE:-true}
      - CORS_ORIGIN=${CORS_ORIGIN:-https://cyberelka2077.ru}
    volumes:
      # Volume для базы данных - данные сохраняются между пересборками контейнера
      - api_data:/app/data
      # Volume для загруженных файлов
      - api_uploads:/app/uploads
    networks:
      - evm-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:4000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  web:
    build:
      context: .
      dockerfile: web/Dockerfile.prod
    image: evm-web:latest
    container_name: evm-web
    restart: unless-stopped
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:4000}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - evm-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  telegram-bot:
    build:
      context: .
      dockerfile: telegram-bot/Dockerfile.prod
    image: evm-telegram-bot:latest
    container_name: evm-telegram-bot
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - BOT_TOKEN=${BOT_TOKEN}
      - API_BASE_URL=${API_BASE_URL:-http://api:4000}
      - API_TIMEOUT=${API_TIMEOUT:-10000}
      - API_RETRY_ATTEMPTS=${API_RETRY_ATTEMPTS:-3}
      - API_RETRY_DELAY=${API_RETRY_DELAY:-1000}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - evm-network
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'node dist/index.js' || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  evm-network:
    driver: bridge

volumes:
  # Постоянное хранилище для базы данных SQLite
  # ⚠️ ВАЖНО: Данные сохраняются между пересборками и перезапусками контейнеров
  # Volume НЕ удаляется при docker-compose down (только при docker-compose down -v)
  # База данных находится в /app/data/evm.sqlite внутри контейнера
  # и сохраняется в Docker volume api_data на хосте
  api_data:
    driver: local
  # Постоянное хранилище для загруженных файлов
  # ⚠️ ВАЖНО: Загруженные файлы сохраняются между перезапусками
  api_uploads:
    driver: local

